datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

generator dbml {
  provider = "prisma-dbml-generator"
}

model User {
  id          String   @id @default(uuid())
  name        String
  phone       String?
  email       String   @unique
  password    String
  level       Int      @default(1)
  cpf         String   @unique
  urlImage    String?
  birthdate   String?
  cep         String?
  estado      String?
  municipio   String?
  bairro      String?
  logradouro  String?
  complemento String?
  numero      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isAdmin     Boolean  @default(false)

  // Relacionamentos
  trilhasCriadas      Trilha[]              @relation("TrilhaCriador")
  participacoes       ParticipacaoTrilha[]  
  desafiosConcluidos  DesafioConcluido[]
  convitesEnviados    ConviteTrilha[]       @relation("ConviteRemetente")
  convitesRecebidos   ConviteTrilha[]       @relation("ConviteDestinatario")
  
  @@index([email])
  @@index([cpf])
}

model Desafio {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  theme       String
  conclusionCriteria String
  location    String
  rewards     Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relacionamentos
  trilhaDesafios      TrilhaDesafio[]
  desafiosConcluidos  DesafioConcluido[]
  
  @@index([theme])
  @@index([isActive])
}

model Trilha {
  id            Int      @id @default(autoincrement())
  title         String
  description   String
  theme         String
  startDate     DateTime
  endDate       DateTime
  totalRewards  Int
  isActive      Boolean  @default(true)
  isHighlighted Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Criador da trilha
  criadorId     String
  criador       User     @relation("TrilhaCriador", fields: [criadorId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  desafios      TrilhaDesafio[]
  participantes ParticipacaoTrilha[]
  convites      ConviteTrilha[]
  
  @@index([criadorId])
  @@index([theme])
  @@index([isActive])
  @@index([isHighlighted])
}

// Tabela intermediária para desafios na trilha
model TrilhaDesafio {
  id         Int      @id @default(autoincrement())
  trilhaId   Int
  desafioId  Int
  ordem      Int      // Ordem do desafio na trilha
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  trilha     Trilha   @relation(fields: [trilhaId], references: [id], onDelete: Cascade)
  desafio    Desafio  @relation(fields: [desafioId], references: [id], onDelete: Cascade)
  
  @@unique([trilhaId, desafioId])
  @@index([trilhaId])
  @@index([desafioId])
}

// Participação de usuários em trilhas
model ParticipacaoTrilha {
  id         Int      @id @default(autoincrement())
  userId     String
  trilhaId   Int
  progress   Float      @default(0) // Progresso do usuário na trilha (%)
  isCompleted Boolean   @default(false)
  joinedAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  trilha     Trilha   @relation(fields: [trilhaId], references: [id], onDelete: Cascade)
  
  @@unique([userId, trilhaId])
  @@index([userId])
  @@index([trilhaId])
}

// Desafios concluídos por usuários
model DesafioConcluido {
  id              Int      @id @default(autoincrement())
  userId          String
  desafioId       Int
  completedAt     DateTime @default(now())
  rewardsEarned   Int      // Recompensas ganhas ao completar
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  desafio         Desafio  @relation(fields: [desafioId], references: [id], onDelete: Cascade)
  
  @@unique([userId, desafioId])
  @@index([userId])
  @@index([desafioId])
}

// Sistema de convites para trilhas
model ConviteTrilha {
  id              Int             @id @default(autoincrement())
  trilhaId        Int
  remetenteId     String
  destinatarioId  String
  status          ConviteStatus   @default(PENDENTE)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime @updatedAt
  
  trilha          Trilha          @relation(fields: [trilhaId], references: [id], onDelete: Cascade)
  remetente       User            @relation("ConviteRemetente", fields: [remetenteId], references: [id], onDelete: Cascade)
  destinatario    User            @relation("ConviteDestinatario", fields: [destinatarioId], references: [id], onDelete: Cascade)
  
  @@unique([trilhaId, destinatarioId])
  @@index([destinatarioId, status])
  @@index([trilhaId])
}

enum ConviteStatus {
  PENDENTE
  ACEITO
  RECUSADO
}

model BairroDestacado {
  id          Int      @id @default(autoincrement())
  name        String
  location    String
  bonusScore  Int      // Mudado de String para Int (pontuação de bônus)
  description String
  tags        String[]
  isActive    Boolean  @default(true)
  urlImage    String?  // Imagem do bairro
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([name])
}

model EventoAgenda {
  id              Int      @id @default(autoincrement())
  title           String
  description     String
  location        String
  eventDate       DateTime // Data do evento
  endDate         DateTime? // Data de término (para eventos de múltiplos dias)
  category        String   // Categoria do evento (música, teatro, exposição, etc)
  urlImage        String?  // Imagem do evento
  urlExternal     String?  // Link externo para mais informações
  isActive        Boolean  @default(true)
  isFeatured      Boolean  @default(false) // Evento em destaque
  tags            String[] // Tags para facilitar busca
  organizador     String?  // Nome do organizador
  preco           String?  // Informação sobre preço (gratuito, valor, etc)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([eventDate])
  @@index([category])
  @@index([isActive])
  @@index([isFeatured])
}
